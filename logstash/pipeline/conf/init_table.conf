input {
  # https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_publication.sql"
    type => "publication"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_dataset.sql"
    type => "dataset"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_experiment.sql"
    type => "experiment"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_ml_model.sql"
    type => "ml_model"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_service.sql"
    type => "service"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_news.sql"
    type => "news"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_event.sql"
    type => "event"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_project.sql"
    type => "project"
  }
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/mysql-connector-java-8.0.22.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://sqlserver:3306/aiod"
    jdbc_user => "root"
    jdbc_password => "ok"
    #sql_log_level => "debug"
    clean_run => true
    record_last_run => false
    statement_filepath => "/usr/share/logstash/sql/init_organisation.sql"
    type => "organisation"
  }
}
# https://www.elastic.co/guide/en/logstash/current/filter-plugins.html+
#filter {
#  mutate {
#    remove_field => ["@version", "@timestamp"]
#  }
#}
filter {
  if ![application_area] {
    mutate {
      replace => {"application_area" => ""}
    }
  }
  mutate {
    split => {"application_area" => ","}
  }
  if [type] == "organisation" {
      ruby {
        code => '
            t = Time.at(event.get("date_founded").to_f)
            event.set("date_founded", t.strftime("%Y-%m-%d"))
        '
      }
  }
}
output {
  # https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html
  if [type] == "publication" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "publication"
        document_id => "publication_%{identifier}"
    }
  }
  if [type] == "dataset" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "dataset"
        document_id => "dataset_%{identifier}"
    }
  }
  if [type] == "experiment" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "experiment"
        document_id => "experiment_%{identifier}"
    }
  }
  if [type] == "ml_model" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "ml_model"
        document_id => "ml_model_%{identifier}"
    }
  }
  if [type] == "service" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "service"
        document_id => "service_%{identifier}"
    }
  }
  if [type] == "news" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "news"
        document_id => "news_%{identifier}"
    }
  }
  if [type] == "event" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "event"
        document_id => "event_%{identifier}"
    }
  }
  if [type] == "project" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "project"
        document_id => "project_%{identifier}"
    }
  }
  if [type] == "organisation" {
    elasticsearch {
        hosts => "elasticsearch:9200"
        user => "elastic"
        password => "changeme"
        ecs_compatibility => disabled
        index => "organisation"
        document_id => "organisation_%{identifier}"
    }
  }
}
